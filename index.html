<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Mortality Data Visualization</title>
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .controls {
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }
        .map-container {
            flex: 1;
            min-width: 600px;
        }
        .sidebar {
            width: 300px;
            flex-shrink: 0;
        }
        .control-group {
            margin-bottom: 25px;
        }
        .year-control {
            margin-top: 30px;
        }
        .control-group h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #555;
            font-size: 16px;
            border-bottom: 2px solid #4A90E2;
            padding-bottom: 5px;
        }
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
        }
        .checkbox-item input[type="checkbox"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .checkbox-item label {
            cursor: pointer;
            font-size: 14px;
        }
        .slider-group {
            margin-top: 20px;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .btn {
            padding: 6px 12px;
            font-size: 13px;
            border: 1px solid #4A90E2;
            background-color: white;
            color: #4A90E2;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn:hover {
            background-color: #4A90E2;
            color: white;
        }
        .slider-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #555;
        }
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #d3d3d3;
            outline: none;
            -webkit-appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4A90E2;
            cursor: pointer;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4A90E2;
            cursor: pointer;
            border: none;
        }
        .year-display {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #4A90E2;
            margin-top: 10px;
        }
        #vis {
            width: 100%;
            min-height: 450px;
            transition: opacity 0.2s ease-in-out;
        }
        #vis.updating {
            opacity: 0.95;
        }
        #timeline {
            width: 100%;
            min-height: 180px;
        }
        #scatter {
            width: 100%;
            min-height: 200px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Global Mortality Data Visualization</h1>
        <p class="subtitle">Interactive exploration of mortality rates by country, cause of death, and demographics (1960-2023)</p>
        
        <div class="controls">
            <div class="map-container">
                <div id="vis" class="loading">Loading visualization...</div>
                <div class="year-control">
                    <div class="slider-group">
                        <label for="yearSlider">Year:</label>
                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                            <button class="btn" id="playButton" style="flex: 0 0 80px;">▶ Play</button>
                        </div>
                        <input type="range" id="yearSlider" min="1960" max="2023" value="2020" step="1">
                        <div class="year-display" id="yearDisplay">2020</div>
                    </div>
                </div>
                <div id="timeline" style="margin-top: 20px;"></div>
                <div id="scatter" style="margin-top: 20px;"></div>
            </div>
            
            <div class="sidebar">
                <div class="control-group">
                    <h3>Sex</h3>
                    <div class="checkbox-group" id="sexFilters"></div>
                </div>
                
                <div class="control-group">
                    <h3>Scale Options</h3>
                    <div class="checkbox-item">
                        <input type="checkbox" id="manualScaleCheckbox">
                        <label for="manualScaleCheckbox">Manual Scale</label>
                    </div>
                    <div class="slider-group" id="scaleSliderGroup" style="display: none; margin-top: 15px;">
                        <label for="scaleSlider">Max Value: <span id="scaleValue">3100</span></label>
                        <input type="range" id="scaleSlider" min="100" max="3100" value="3100" step="50">
                    </div>
                </div>
                
                <div class="control-group">
                    <h3>Cause of Death</h3>
                    <div class="button-group">
                        <button class="btn" id="selectAllCauses">Select All</button>
                        <button class="btn" id="deselectAllCauses">Deselect All</button>
                    </div>
                    <div class="checkbox-group" id="causeFilters"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let allData = [];
        let filteredData = [];
        let sexFilters = new Set(['M', 'F']); // All selected by default
        let causeFilters = new Set();
        let currentYear = 2020;
        let vegaView = null; // Store the Vega view for updates
        let manualScale = false;
        let maxScaleValue = 3100;
        let isPlaying = false;
        let playInterval = null;
        let timelineView = null; // Store the timeline chart view
        let scatterView = null; // Store the scatter chart view
        let scatterMaxValue = 0; // Store max value for scatter x-axis
        let selectedCountry = null; // Store selected country code for highlighting

        // Country centroids for mapping
        const countryCentroids = {
            'AUS': [-25.0, 133.0], 'AUT': [47.5, 14.5], 'BEL': [50.5, 4.5], 'CAN': [60.0, -95.0],
            'CHL': [-30.0, -71.0], 'COL': [4.0, -72.0], 'CRI': [10.0, -84.0], 'CZE': [49.75, 15.5],
            'DNK': [56.0, 10.0], 'EST': [59.0, 26.0], 'FIN': [64.0, 26.0], 'FRA': [46.0, 2.0],
            'DEU': [51.0, 9.0], 'GRC': [39.0, 22.0], 'HUN': [47.0, 20.0], 'ISL': [65.0, -18.0],
            'IRL': [53.0, -8.0], 'ISR': [31.5, 34.75], 'ITA': [42.83, 12.83], 'JPN': [36.0, 138.0],
            'KOR': [37.0, 127.5], 'LVA': [57.0, 25.0], 'LTU': [56.0, 24.0], 'LUX': [49.75, 6.17],
            'MEX': [23.0, -102.0], 'NLD': [52.5, 5.75], 'NZL': [-41.0, 174.0], 'NOR': [62.0, 10.0],
            'POL': [52.0, 20.0], 'PRT': [39.5, -8.0], 'SVK': [48.67, 19.5], 'SVN': [46.0, 15.0],
            'ESP': [40.0, -4.0], 'SWE': [62.0, 15.0], 'CHE': [47.0, 8.0], 'TUR': [39.0, 35.0],
            'GBR': [54.0, -2.0], 'USA': [38.0, -97.0], 'RUS': [60.0, 100.0], 'CHN': [35.0, 105.0],
            'IND': [20.0, 77.0], 'BRA': [-10.0, -55.0], 'ZAF': [-29.0, 24.0], 'ARG': [-34.0, -64.0],
            'PER': [-10.0, -76.0], 'VEN': [8.0, -66.0], 'CUB': [21.5, -80.0], 'DOM': [19.0, -70.5],
            'PAN': [9.0, -80.0], 'URY': [-33.0, -56.0], 'PRY': [-23.0, -58.0], 'BOL': [-17.0, -65.0],
            'ECU': [-2.0, -77.5], 'GTM': [15.5, -90.25], 'HND': [15.0, -86.5], 'SLV': [13.83, -88.92],
            'NIC': [13.0, -85.0], 'BLZ': [17.25, -88.75], 'HTI': [19.0, -72.42], 'JAM': [18.25, -77.5],
            'TTO': [11.0, -61.0], 'BHS': [24.25, -76.0], 'BRB': [13.17, -59.53], 'GRD': [12.12, -61.67],
            'LCA': [13.88, -61.13], 'VCT': [13.25, -61.2], 'ATG': [17.05, -61.8], 'DMA': [15.42, -61.33],
            'KNA': [17.33, -62.75], 'EGY': [27.0, 30.0], 'MAR': [32.0, -5.0], 'DZA': [28.0, 3.0],
            'TUN': [34.0, 9.0], 'LBY': [25.0, 17.0], 'SDN': [15.0, 30.0], 'ETH': [8.0, 38.0],
            'KEN': [1.0, 38.0], 'UGA': [1.0, 32.0], 'TZA': [-6.0, 35.0], 'MOZ': [-18.25, 35.0],
            'ZWE': [-20.0, 30.0], 'BWA': [-22.0, 24.0], 'NAM': [-22.0, 17.0], 'AGO': [-12.5, 18.5],
            'ZMB': [-15.0, 30.0], 'MWI': [-13.5, 34.0], 'MDG': [-20.0, 47.0], 'MUS': [-20.28, 57.55],
            'SYC': [-4.58, 55.67], 'COM': [-12.17, 44.25], 'GHA': [8.0, -2.0], 'NGA': [10.0, 8.0],
            'CIV': [8.0, -5.0], 'SEN': [14.0, -14.0], 'MLI': [17.0, -4.0], 'BFA': [13.0, -2.0],
            'NER': [16.0, 8.0], 'TCD': [15.0, 19.0], 'CMR': [6.0, 12.0], 'CAF': [7.0, 21.0],
            'COG': [-1.0, 15.0], 'COD': [0.0, 25.0], 'GAB': [-1.0, 11.75], 'GNQ': [2.0, 10.0],
            'GNB': [12.0, -15.0], 'GIN': [11.0, -10.0], 'SLE': [8.5, -11.5], 'LBR': [6.5, -9.5],
            'TGO': [8.0, 1.17], 'BEN': [9.5, 2.25], 'MRT': [20.0, -12.0], 'GMB': [13.47, -16.57],
            'CPV': [16.0, -24.0], 'STP': [1.0, 7.0], 'SOM': [10.0, 49.0], 'DJI': [11.5, 43.0],
            'ERI': [15.0, 39.0], 'RWA': [-2.0, 30.0], 'BDI': [-3.5, 30.0], 'IRQ': [33.0, 44.0],
            'IRN': [32.0, 53.0], 'SAU': [25.0, 45.0], 'YEM': [15.0, 48.0], 'OMN': [21.0, 57.0],
            'ARE': [24.0, 54.0], 'QAT': [25.5, 51.25], 'BHR': [26.0, 50.55], 'KWT': [29.5, 45.75],
            'JOR': [31.0, 36.0], 'LBN': [33.83, 35.83], 'SYR': [35.0, 38.0], 'AFG': [33.0, 65.0],
            'PAK': [30.0, 70.0], 'BGD': [24.0, 90.0], 'LKA': [7.0, 81.0], 'NPL': [28.0, 84.0],
            'BTN': [27.5, 90.5], 'MDV': [3.25, 73.0], 'MMR': [22.0, 98.0], 'THA': [15.0, 100.0],
            'LAO': [18.0, 105.0], 'VNM': [16.0, 108.0], 'KHM': [13.0, 105.0], 'MYS': [2.5, 112.5],
            'SGP': [1.37, 103.8], 'IDN': [-5.0, 120.0], 'PHL': [13.0, 122.0], 'PRK': [40.0, 127.0],
            'MNG': [46.0, 105.0], 'KAZ': [48.0, 68.0], 'UZB': [41.0, 64.0], 'TKM': [40.0, 60.0],
            'KGZ': [41.0, 75.0], 'TJK': [39.0, 71.0], 'ARM': [40.0, 45.0], 'AZE': [40.5, 47.5],
            'GEO': [42.0, 43.5], 'BLR': [53.0, 28.0], 'UKR': [49.0, 32.0], 'MDA': [47.0, 29.0],
            'ROU': [46.0, 25.0], 'BGR': [43.0, 25.0], 'HRV': [45.17, 15.5], 'BIH': [44.0, 18.0],
            'SRB': [44.0, 21.0], 'MNE': [42.5, 19.3], 'MKD': [41.83, 22.0], 'ALB': [41.0, 20.0],
            'CYP': [35.0, 33.0], 'MLT': [35.83, 14.58]
        };

        // Parse CSV line handling quoted fields
        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    values.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            values.push(current.trim());
            return values;
        }

        // Load the CSV data
        async function loadData() {
            try {
                const response = await fetch('data.csv');
                const text = await response.text();
                const lines = text.split('\n');
                
                allData = lines.slice(1)
                    .filter(line => line.trim())
                    .map(line => {
                        const values = parseCSVLine(line);
                        return {
                            country: values[0],
                            countryName: values[1],
                            sex: values[2],
                            sexLabel: values[3],
                            causeCode: values[4],
                            cause: values[5] || '',
                            year: parseInt(values[6]),
                            value: parseFloat(values[7]) || 0
                        };
                    })
                    .filter(d => d.country && d.year && !isNaN(d.value));

                console.log(`Loaded ${allData.length} data points`);
                
                // Get unique causes and create checkboxes
                const causes = [...new Set(allData.map(d => d.cause))].sort();
                causeFilters = new Set(causes.slice(0, 5)); // Select first 5 by default
                
                createFilters(causes);
                updateAll();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('vis').innerHTML = '<p style="color: red;">Error loading data. Please make sure data.csv is in the same directory.</p>';
            }
        }

        // Create filter checkboxes
        function createFilters(causes) {
            // Sex filters
            const sexContainer = document.getElementById('sexFilters');
            const sexOptions = [
                { value: 'M', label: 'Male' },
                { value: 'F', label: 'Female' }
            ];
            
            sexOptions.forEach(option => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                div.innerHTML = `
                    <input type="checkbox" id="sex_${option.value}" value="${option.value}" checked>
                    <label for="sex_${option.value}">${option.label}</label>
                `;
                div.querySelector('input').addEventListener('change', (e) => {
                    if (e.target.checked) {
                        sexFilters.add(option.value);
                    } else {
                        sexFilters.delete(option.value);
                    }
                    vegaView = null; // Force rebuild on filter change
                    scatterView = null;
                    updateAll();
                });
                sexContainer.appendChild(div);
            });

            // Cause filters
            const causeContainer = document.getElementById('causeFilters');
            causes.forEach((cause, index) => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                const isChecked = index < 5; // Check first 5
                div.innerHTML = `
                    <input type="checkbox" id="cause_${index}" value="${cause}" ${isChecked ? 'checked' : ''}>
                    <label for="cause_${index}">${cause}</label>
                `;
                div.querySelector('input').addEventListener('change', (e) => {
                    if (e.target.checked) {
                        causeFilters.add(cause);
                    } else {
                        causeFilters.delete(cause);
                    }
                    vegaView = null; // Force rebuild on filter change
                    scatterView = null;
                    updateAll();
                });
                causeContainer.appendChild(div);
            });
            
            // Select All / Deselect All buttons
            document.getElementById('selectAllCauses').addEventListener('click', () => {
                causes.forEach(cause => causeFilters.add(cause));
                causes.forEach((cause, index) => {
                    document.getElementById(`cause_${index}`).checked = true;
                });
                vegaView = null; // Force rebuild on filter change
                scatterView = null;
                updateAll();
            });
            
            document.getElementById('deselectAllCauses').addEventListener('click', () => {
                causeFilters.clear();
                causes.forEach((cause, index) => {
                    document.getElementById(`cause_${index}`).checked = false;
                });
                vegaView = null; // Force rebuild on filter change
                scatterView = null;
                updateAll();
            });
        }
        
        // Manual scale controls
        const manualScaleCheckbox = document.getElementById('manualScaleCheckbox');
        const scaleSliderGroup = document.getElementById('scaleSliderGroup');
        const scaleSlider = document.getElementById('scaleSlider');
        const scaleValue = document.getElementById('scaleValue');
        
        manualScaleCheckbox.addEventListener('change', (e) => {
            manualScale = e.target.checked;
            scaleSliderGroup.style.display = manualScale ? 'block' : 'none';
            vegaView = null; // Force rebuild
            scatterView = null;
            updateAll();
        });
        
        scaleSlider.addEventListener('input', (e) => {
            maxScaleValue = parseInt(e.target.value);
            scaleValue.textContent = maxScaleValue;
            vegaView = null; // Force rebuild
            scatterView = null;
            updateAll();
        });

        // Year slider
        const yearSlider = document.getElementById('yearSlider');
        const yearDisplay = document.getElementById('yearDisplay');
        const playButton = document.getElementById('playButton');
        let yearUpdateTimeout = null;
        
        yearSlider.addEventListener('input', (e) => {
            currentYear = parseInt(e.target.value);
            yearDisplay.textContent = currentYear;
            
            // Stop playing if user manually moves slider
            if (isPlaying) {
                stopPlaying();
            }
            
            // Update title immediately but debounce the visualization update
            if (yearUpdateTimeout) {
                clearTimeout(yearUpdateTimeout);
            }
            yearUpdateTimeout = setTimeout(() => {
                updateVisualization();
                updateTimeline();
                updateScatter();
            }, 50); // 50ms debounce for smooth updates
        });
        
        // Play button functionality
        playButton.addEventListener('click', () => {
            if (isPlaying) {
                stopPlaying();
            } else {
                startPlaying();
            }
        });
        
        function startPlaying() {
            isPlaying = true;
            playButton.textContent = '⏸ Pause';
            
            playInterval = setInterval(() => {
                if (currentYear < 2023) {
                    currentYear++;
                    yearSlider.value = currentYear;
                    yearDisplay.textContent = currentYear;
                    updateVisualization();
                    updateTimeline();
                    updateScatter();
                } else {
                    stopPlaying();
                }
            }, 300); // Change year every 500ms
        }
        
        function stopPlaying() {
            isPlaying = false;
            playButton.textContent = '▶ Play';
            if (playInterval) {
                clearInterval(playInterval);
                playInterval = null;
            }
        }

        // Filter and aggregate data
        function prepareData() {
            // Filter data
            filteredData = allData.filter(d => 
                sexFilters.has(d.sex) &&
                causeFilters.has(d.cause) &&
                d.year === currentYear
            );

            // Aggregate by country
            const aggregated = {};
            filteredData.forEach(d => {
                if (!aggregated[d.country]) {
                    aggregated[d.country] = {
                        country: d.country,
                        countryName: d.countryName,
                        totalValue: 0,
                        count: 0
                    };
                }
                aggregated[d.country].totalValue += d.value;
                aggregated[d.country].count += 1;
            });

            return Object.values(aggregated)
                .filter(d => countryCentroids[d.country]) // Only include countries with known coordinates
                .map(d => ({
                    country: d.country,
                    countryName: d.countryName,
                    averageValue: d.totalValue / d.count,
                    totalValue: d.totalValue,
                    latitude: countryCentroids[d.country][0],
                    longitude: countryCentroids[d.country][1]
                }));
        }
        
        // Prepare data for countries without data (to show in grey)
        function prepareGreyCountries(dataWithValues) {
            const countriesWithData = new Set(dataWithValues.map(d => d.country));
            const allCountriesInDataset = [...new Set(allData.map(d => d.country))];
            
            return allCountriesInDataset
                .filter(country => !countriesWithData.has(country) && countryCentroids[country])
                .map(country => ({
                    country: country,
                    countryName: allData.find(d => d.country === country)?.countryName || country,
                    latitude: countryCentroids[country][0],
                    longitude: countryCentroids[country][1]
                }));
        }
        
        // Select/deselect a country for highlighting
        function selectCountry(countryCode) {
            console.log('Country selected:', countryCode);
            if (selectedCountry === countryCode) {
                selectedCountry = null; // Deselect if clicking same country
                console.log('Country deselected');
            } else {
                selectedCountry = countryCode;
                console.log('Country now highlighted:', selectedCountry);
            }
            // Force rebuild to update color conditions
            vegaView = null;
            scatterView = null;
            // Update both visualizations to show highlight
            updateVisualization();
            updateScatter();
        }
        
        // Calculate max scatter value across all years for current filters
        function calculateScatterMax() {
            const filteredByFilters = allData.filter(d => 
                sexFilters.has(d.sex) &&
                causeFilters.has(d.cause)
            );
            
            const countryYearTotals = {};
            filteredByFilters.forEach(d => {
                const key = `${d.country}_${d.year}`;
                if (!countryYearTotals[key]) {
                    countryYearTotals[key] = 0;
                }
                countryYearTotals[key] += d.value;
            });
            
            return Math.max(...Object.values(countryYearTotals), 0);
        }
        
        // Prepare scatter plot data (countries for current year)
        function prepareScatterData() {
            const filteredByYear = allData.filter(d => 
                sexFilters.has(d.sex) &&
                causeFilters.has(d.cause) &&
                d.year === currentYear
            );
            
            const countryTotals = {};
            filteredByYear.forEach(d => {
                if (!countryTotals[d.country]) {
                    countryTotals[d.country] = {
                        country: d.country,
                        countryName: d.countryName,
                        total: 0
                    };
                }
                countryTotals[d.country].total += d.value;
            });
            
            // Add consistent jitter for y-position based on country code
            return Object.values(countryTotals).map(d => {
                // Simple hash function for consistent jitter
                let hash = 0;
                for (let i = 0; i < d.country.length; i++) {
                    hash = ((hash << 5) - hash) + d.country.charCodeAt(i);
                    hash = hash & hash;
                }
                return {
                    ...d,
                    jitter: (Math.abs(hash) % 1000) / 1000
                };
            });
        }
        
        // Prepare timeline data (total mortalities per year)
        function prepareTimelineData() {
            const filteredByFilters = allData.filter(d => 
                sexFilters.has(d.sex) &&
                causeFilters.has(d.cause)
            );
            
            const yearTotals = {};
            filteredByFilters.forEach(d => {
                if (!yearTotals[d.year]) {
                    yearTotals[d.year] = 0;
                }
                yearTotals[d.year] += d.value;
            });
            
            return Object.entries(yearTotals)
                .map(([year, total]) => ({
                    year: parseInt(year),
                    total: total,
                    isCurrentYear: parseInt(year) === currentYear
                }))
                .sort((a, b) => a.year - b.year);
        }

        // Create timeline chart specification
        function createTimelineSpec(data) {
            return {
                "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
                "width": "container",
                "height": 150,
                "title": {
                    "text": "Total Mortality Over Time",
                    "fontSize": 14
                },
                "data": {
                    "values": data
                },
                "mark": {
                    "type": "bar",
                    "cursor": "pointer"
                },
                "encoding": {
                    "x": {
                        "field": "year",
                        "type": "ordinal",
                        "scale": {
                            "domain": Array.from({length: 64}, (_, i) => 1960 + i)
                        },
                        "axis": {
                            "labelAngle": -45,
                            "title": "Year"
                        }
                    },
                    "y": {
                        "field": "total",
                        "type": "quantitative",
                        "axis": {
                            "title": "Total Mortality Rate"
                        }
                    },
                    "color": {
                        "condition": {
                            "test": "datum.isCurrentYear",
                            "value": "#FF6B6B"
                        },
                        "value": "#4A90E2"
                    },
                    "tooltip": [
                        {"field": "year", "type": "ordinal", "title": "Year"},
                        {"field": "total", "type": "quantitative", "title": "Total Mortality", "format": ",.0f"}
                    ]
                },
                "config": {
                    "view": {
                        "stroke": null
                    }
                }
            };
        }
        
        // Create scatter plot specification
        function createScatterSpec(data, maxValue) {
            return {
                "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
                "width": "container",
                "height": 180,
                "title": {
                    "text": "Mortality Distribution by Country",
                    "fontSize": 14
                },
                "datasets": {
                    "scatterData": []
                },
                "data": {
                    "name": "scatterData"
                },
                "mark": {
                    "type": "circle",
                    "size": 100,
                    "opacity": 0.6,
                    "stroke": "#4A90E2",
                    "strokeWidth": 1,
                    "cursor": "pointer"
                },
                "encoding": {
                    "x": {
                        "field": "total",
                        "type": "quantitative",
                        "axis": {
                            "title": "Total Mortality Rate",
                            "grid": true
                        },
                        "scale": {
                            "domain": [0, maxValue]
                        }
                    },
                    "y": {
                        "field": "jitter",
                        "type": "quantitative",
                        "axis": null,
                        "scale": {
                            "domain": [0, 1]
                        }
                    },
                    "key": {
                        "field": "country",
                        "type": "nominal"
                    },
                    "color": {
                        "condition": selectedCountry ? {
                            "test": "datum.country === '" + selectedCountry + "'",
                            "value": "#00CC66"
                        } : {
                            "test": "false",
                            "value": "#00CC66"
                        },
                        "value": "#4A90E2"
                    },
                    "tooltip": [
                        {"field": "countryName", "type": "nominal", "title": "Country"},
                        {"field": "total", "type": "quantitative", "title": "Total Mortality", "format": ",.0f"}
                    ]
                },
                "config": {
                    "view": {
                        "stroke": null
                    }
                }
            };
        }
        
        // Update scatter plot
        async function updateScatter() {
            const data = prepareScatterData();
            console.log('Scatter data:', data.length, 'countries');
            
            if (data.length === 0) {
                document.getElementById('scatter').innerHTML = '';
                scatterView = null;
                return;
            }
            
            try {
                if (scatterView) {
                    // Update existing visualization with smooth transitions
                    const changeset = vega.changeset()
                        .remove(() => true)
                        .insert(data);
                    scatterView.change('scatterData', changeset);
                    scatterView.runAsync();
                } else {
                    // Recalculate max value when rebuilding
                    scatterMaxValue = calculateScatterMax();
                    
                    // First time: create the visualization
                    const spec = createScatterSpec(data, scatterMaxValue);
                    const result = await vegaEmbed('#scatter', spec, {
                        actions: false,
                        renderer: 'canvas'
                    });
                    scatterView = result.view;
                    
                    // Initialize the dataset
                    scatterView.insert('scatterData', data);
                    scatterView.run();
                    
                    // Add click handler for country selection
                    scatterView.addEventListener('click', function(event, item) {
                        console.log('Scatter clicked:', item);
                        if (item && item.datum && item.datum.country) {
                            selectCountry(item.datum.country);
                        }
                    });
                }
            } catch (error) {
                console.error('Error rendering scatter:', error);
                scatterView = null;
            }
        }
        
        // Update timeline chart
        async function updateTimeline() {
            const data = prepareTimelineData();
            console.log('Timeline data:', data.length, 'years');
            
            if (data.length === 0) {
                document.getElementById('timeline').innerHTML = '';
                return;
            }
            
            const spec = createTimelineSpec(data);
            
            try {
                const result = await vegaEmbed('#timeline', spec, {
                    actions: false,
                    renderer: 'canvas'
                });
                timelineView = result.view;
                
                // Add click interaction to jump to year
                timelineView.addEventListener('click', function(event, item) {
                    if (item && item.datum && item.datum.year) {
                        currentYear = item.datum.year;
                        yearSlider.value = currentYear;
                        yearDisplay.textContent = currentYear;
                        updateVisualization();
                        updateTimeline();
                    }
                });
            } catch (error) {
                console.error('Error rendering timeline:', error);
            }
        }

        // Create Vega-Lite specification
        function createSpec(data) {
            return {
                "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
                "width": "container",
                "height": 450,
                "title": {
                    "text": `Mortality Rates by Country`,
                    "fontSize": 20,
                    "anchor": "start"
                },
                "datasets": {
                    "circleData": [],
                    "greyCountries": []
                },
                "data": {
                    "url": "https://raw.githubusercontent.com/vega/vega-datasets/master/data/world-110m.json",
                    "format": {
                        "type": "topojson",
                        "feature": "countries"
                    }
                },
                "projection": {
                    "type": "naturalEarth1"
                },
                "layer": [
                    {
                        "mark": {
                            "type": "geoshape",
                            "fill": "#e8e8e8",
                            "stroke": "#ffffff",
                            "strokeWidth": 0.5,
                            "tooltip": null
                        }
                    },
                    {
                        "data": {
                            "name": "greyCountries"
                        },
                        "mark": {
                            "type": "circle",
                            "opacity": 0.3,
                            "stroke": "#999",
                            "strokeWidth": 0.5,
                            "size": 50,
                            "filled": true,
                            "fill": "#777777",
                            "tooltip": "No Data"
                        },
                        "encoding": {
                            "longitude": {
                                "field": "longitude",
                                "type": "quantitative"
                            },
                            "latitude": {
                                "field": "latitude",
                                "type": "quantitative"
                            }
                        }
                    },
                    {
                        "data": {
                            "name": "circleData"
                        },
                        "mark": {
                            "type": "circle",
                            "opacity": 0.6,
                            "stroke": "white",
                            "strokeWidth": 1,
                            "tooltip": true,
                            "cursor": "pointer"
                        },
                        "encoding": {
                            "longitude": {
                                "field": "longitude",
                                "type": "quantitative"
                            },
                            "latitude": {
                                "field": "latitude",
                                "type": "quantitative"
                            },
                            "key": {
                                "field": "country",
                                "type": "nominal"
                            },
                            "size": {
                                "field": "totalValue",
                                "type": "quantitative",
                                "scale": {
                                    "type": "sqrt",
                                    "domain": manualScale ? [0, maxScaleValue] : undefined,
                                    "range": [30, 800]
                                },
                                "legend": {
                                    "title": "Total Mortality Rate",
                                    "orient": "left",
                                    "symbolLimit": 50,
                                    "tickCount": 5
                                }
                            },
                            "color": {
                                "condition": selectedCountry ? {
                                    "test": "datum.country === '" + selectedCountry + "'",
                                    "value": "#00CC66"
                                } : {
                                    "test": "false",
                                    "value": "#00CC66"
                                },
                                "value": "#4A90E2"
                            },
                            "tooltip": [
                                {"field": "countryName", "type": "nominal", "title": "Country"},
                                {"field": "country", "type": "nominal", "title": "Code"},
                                {"field": "totalValue", "type": "quantitative", "title": "Total Mortality Rate", "format": ".2f"}
                            ]
                        }
                    }
                ],
                "config": {
                    "view": {
                        "stroke": null,
                        "continuousWidth": 900,
                        "continuousHeight": 450
                    },
                    "mark": {
                        "tooltip": true,
                        "interpolate": "linear"
                    },
                    "axis": {
                        "domainWidth": 1
                    }
                }
            };
        }

        // Update visualization
        async function updateVisualization() {
            const data = prepareData();
            const greyCountries = prepareGreyCountries(data);
            console.log(`Visualizing ${data.length} countries, ${greyCountries.length} grey`);
            
            if (data.length === 0) {
                document.getElementById('vis').innerHTML = '<p style="text-align: center; color: #999;">No data available for current filters</p>';
                vegaView = null;
                return;
            }

            try {
                if (vegaView) {
                    // Update existing visualization data smoothly
                    const changeset = vega.changeset()
                        .remove(() => true)
                        .insert(data);
                    vegaView.change('circleData', changeset);
                    
                    const greyChangeset = vega.changeset()
                        .remove(() => true)
                        .insert(greyCountries);
                    vegaView.change('greyCountries', greyChangeset);
                    
                    vegaView.runAsync();
                } else {
                    // First time: create the visualization
                    const spec = createSpec(data);
                    const result = await vegaEmbed('#vis', spec, {
                        actions: {
                            export: true,
                            source: false,
                            compiled: false,
                            editor: false
                        },
                        renderer: 'canvas'
                    });
                    vegaView = result.view;
                    
                    // Initialize the datasets
                    vegaView.insert('circleData', data);
                    vegaView.insert('greyCountries', greyCountries);
                    vegaView.run();
                    
                    // Add click handler for country selection
                    vegaView.addEventListener('click', function(event, item) {
                        console.log('Map clicked:', item);
                        if (item && item.datum && item.datum.country) {
                            selectCountry(item.datum.country);
                        }
                    });
                }
            } catch (error) {
                console.error('Error rendering visualization:', error);
                vegaView = null;
            }
        }
        
        // Update all visualizations
        async function updateAll() {
            console.log('updateAll called');
            await updateVisualization();
            await updateTimeline();
            await updateScatter();
        }

        // Initialize
        loadData();
    </script>
</body>
</html>
